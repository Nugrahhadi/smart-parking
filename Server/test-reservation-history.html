<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Reservation History</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #2196f3;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      button.secondary {
        background: #2196f3;
      }
      button.secondary:hover {
        background: #0b7dda;
      }
      input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 250px;
        margin: 5px;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #e8f5e9;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: "Courier New", monospace;
        max-height: 500px;
        overflow-y: auto;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #4caf50;
        color: white;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
      }
      .badge-active {
        background: #4caf50;
        color: white;
      }
      .badge-pending {
        background: #ff9800;
        color: white;
      }
      .badge-completed {
        background: #2196f3;
        color: white;
      }
      .badge-cancelled {
        background: #f44336;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üÖøÔ∏è Test Reservation History</h1>

      <div class="section">
        <h2>Step 1: Login</h2>
        <input
          type="email"
          id="email"
          placeholder="Email"
          value="buyer@test.com"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          value="password"
        />
        <button onclick="login()">Login</button>
        <div id="loginResult" class="result" style="display: none"></div>
      </div>

      <div class="section">
        <h2>Step 2: Get Reservation History</h2>
        <button class="secondary" onclick="getReservations()">
          üìã Get My Reservations
        </button>
        <div id="reservationsResult" class="result" style="display: none"></div>
        <div id="reservationsTable"></div>
      </div>

      <div class="section">
        <h2>Direct Test (No Login Required)</h2>
        <input
          type="text"
          id="token"
          placeholder="Paste JWT Token Here"
          style="width: 500px"
        />
        <button class="secondary" onclick="testWithToken()">
          Test with Token
        </button>
        <div id="directResult" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:5000/api";
      let authToken = localStorage.getItem("token");

      // Update token display if exists
      if (authToken) {
        document.getElementById("token").value = authToken;
      }

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const resultDiv = document.getElementById("loginResult");

        resultDiv.style.display = "block";
        resultDiv.className = "result";
        resultDiv.textContent = "‚è≥ Logging in...";

        try {
          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.token;
            localStorage.setItem("token", authToken);
            document.getElementById("token").value = authToken;

            resultDiv.className = "result success";
            resultDiv.textContent = `‚úÖ LOGIN SUCCESS!\n\nUser: ${data.user.name}\nEmail: ${data.user.email}\nRole: ${data.user.role}\n\nToken saved!`;
          } else {
            resultDiv.className = "result error";
            resultDiv.textContent = `‚ùå LOGIN FAILED!\n\n${
              data.message || "Unknown error"
            }`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = `‚ùå ERROR!\n\n${error.message}`;
        }
      }

      async function getReservations() {
        const resultDiv = document.getElementById("reservationsResult");
        const tableDiv = document.getElementById("reservationsTable");

        if (!authToken) {
          resultDiv.style.display = "block";
          resultDiv.className = "result error";
          resultDiv.textContent = "‚ùå Please login first!";
          return;
        }

        resultDiv.style.display = "block";
        resultDiv.className = "result";
        resultDiv.textContent = "‚è≥ Fetching reservations...";
        tableDiv.innerHTML = "";

        try {
          console.log("üîë Using token:", authToken.substring(0, 20) + "...");

          const response = await fetch(
            `${API_URL}/reservations/my-reservations`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
            }
          );

          console.log("üì° Response status:", response.status);
          const data = await response.json();
          console.log("üì¶ Response data:", data);

          if (response.ok) {
            resultDiv.className = "result success";
            resultDiv.textContent = `‚úÖ SUCCESS!\n\nTotal Reservations: ${
              data.reservations?.length || 0
            }\n\nRaw Response:\n${JSON.stringify(data, null, 2)}`;

            // Create table
            if (data.reservations && data.reservations.length > 0) {
              displayReservationsTable(data.reservations);
            } else {
              tableDiv.innerHTML =
                '<p style="color: #666; font-style: italic;">No reservations found.</p>';
            }
          } else {
            resultDiv.className = "result error";
            resultDiv.textContent = `‚ùå FAILED!\n\nStatus: ${
              response.status
            }\nMessage: ${
              data.message || "Unknown error"
            }\n\nFull Response:\n${JSON.stringify(data, null, 2)}`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = `‚ùå ERROR!\n\n${error.message}\n\nStack:\n${error.stack}`;
        }
      }

      async function testWithToken() {
        const token = document.getElementById("token").value;
        const resultDiv = document.getElementById("directResult");

        if (!token) {
          alert("Please enter a token!");
          return;
        }

        authToken = token;
        localStorage.setItem("token", token);

        resultDiv.style.display = "block";
        resultDiv.className = "result";
        resultDiv.textContent = "‚è≥ Testing with provided token...";

        try {
          const response = await fetch(
            `${API_URL}/reservations/my-reservations`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            resultDiv.className = "result success";
            resultDiv.textContent = `‚úÖ SUCCESS!\n\nTotal Reservations: ${
              data.reservations?.length || 0
            }\n\nRaw Response:\n${JSON.stringify(data, null, 2)}`;

            if (data.reservations && data.reservations.length > 0) {
              displayReservationsTable(data.reservations);
            }
          } else {
            resultDiv.className = "result error";
            resultDiv.textContent = `‚ùå FAILED!\n\nStatus: ${
              response.status
            }\nMessage: ${data.message}\n\nFull Response:\n${JSON.stringify(
              data,
              null,
              2
            )}`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = `‚ùå ERROR!\n\n${error.message}`;
        }
      }

      function displayReservationsTable(reservations) {
        const tableDiv = document.getElementById("reservationsTable");

        let html = "<table>";
        html += "<thead><tr>";
        html += "<th>ID</th>";
        html += "<th>Location</th>";
        html += "<th>Spot</th>";
        html += "<th>Start Time</th>";
        html += "<th>End Time</th>";
        html += "<th>Duration</th>";
        html += "<th>Total</th>";
        html += "<th>Status</th>";
        html += "<th>Payment</th>";
        html += "</tr></thead>";
        html += "<tbody>";

        reservations.forEach((r) => {
          const startTime = new Date(r.start_time).toLocaleString("id-ID");
          const endTime = new Date(r.end_time).toLocaleString("id-ID");
          const duration = calculateDuration(r.start_time, r.end_time);

          html += "<tr>";
          html += `<td>${r.id}</td>`;
          html += `<td>${r.location_name || "N/A"}</td>`;
          html += `<td>${r.spot_number || "N/A"}</td>`;
          html += `<td>${startTime}</td>`;
          html += `<td>${endTime}</td>`;
          html += `<td>${duration}</td>`;
          html += `<td>Rp ${Number(r.total_amount || 0).toLocaleString(
            "id-ID"
          )}</td>`;
          html += `<td><span class="badge badge-${r.status}">${r.status}</span></td>`;
          html += `<td><span class="badge badge-${
            r.payment_status || "pending"
          }">${r.payment_status || "unpaid"}</span></td>`;
          html += "</tr>";
        });

        html += "</tbody></table>";
        tableDiv.innerHTML = html;
      }

      function calculateDuration(start, end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        const diff = Math.abs(endDate - startDate);
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}h ${minutes}m`;
      }
    </script>
  </body>
</html>
